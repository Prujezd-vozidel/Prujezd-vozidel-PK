angular.module("pvpk",["ngResource"]),angular.module("pvpk").constant("config",{APP_NAME:"PVPK",APP_VERSION:"1.3.3",API_URL:API_URL,API_TOKEN:API_TOKEN,DEFAULT_POSITION:{lat:49.53,lng:13.3},DEFAULT_ZOOM:10,DEFAULT_ZOOM_MIN:7,DEFAULT_RANGE_DATE_DAY:{from:-30,to:-1},DEFAULT_RANGE_TIME_HOUR:{from:7,to:16}}),angular.module("pvpk").factory("Device",["$resource","config",function(e,o){return e(o.API_URL+"/devices/:id",{id:"@id",period:"@period"},{get:{url:o.API_URL+"/devices/:id/:period",method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",jwt:o.API_TOKEN}},query:{url:o.API_URL+"/devices",method:"GET",isArray:!0,headers:{"Content-Type":"application/json",Accept:"application/json",jwt:o.API_TOKEN}}})}]),angular.module("pvpk").factory("Range",["$resource","config",function(e,o){return e(o.API_URL+"/range",null,{get:{url:o.API_URL+"/range",method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",jwt:o.API_TOKEN}}})}]),angular.module("pvpk").factory("Vehicle",["$resource","config",function(e,o){return e(o.API_URL+"/vehicles",null,{query:{url:o.API_URL+"/vehicles",method:"GET",isArray:!0,headers:{"Content-Type":"application/json",Accept:"application/json",jwt:o.API_TOKEN}}})}]),angular.module("pvpk").controller("infoController",["$rootScope","$scope","$location","config","Device","Vehicle","Range",function(u,g,i,a,r,e,n){this.$onInit=function(){u.selectDevice=null,g.showInfoLoading=!1,g.vehicles=[],g.urlExportCsv=null,g.directions=[{id:void 0,name:"po směru i proti směru"},{id:1,name:"po směru"},{id:2,name:"proti směru"}],g.isLoadRange=!1,e.query(null,function(e){g.vehicles=e},function(e){u.graphShow=!1,console.log("Error api all Vehicles"),u.handleErrorResponse(e)}),u.$emit("setRangeFromUrl",null)},u.$on("setRangeFromUrl",function(e,o){var t=i.search();g.range={fromDate:moment(t.fromDate,"YYYY-MM-DD").isValid()?moment(t.fromDate).toDate():moment().add(a.DEFAULT_RANGE_DATE_DAY.from,"d").toDate(),toDate:moment(t.toDate,"YYYY-MM-DD").isValid()?moment(t.toDate).toDate():moment().add(a.DEFAULT_RANGE_DATE_DAY.to,"d").toDate(),fromTime:moment(t.fromTime,"HH:mm").isValid()?moment(t.fromTime,"HH:mm").toDate():moment({hour:a.DEFAULT_RANGE_TIME_HOUR.from}).toDate(),toTime:moment(t.toTime,"HH:mm").isValid()?moment(t.toTime,"HH:mm").toDate():moment({hour:a.DEFAULT_RANGE_TIME_HOUR.to}).toDate(),isTime:0!=t.isTime,maxDate:null==g.range?null:g.range.maxDate,minDate:null==g.range?null:g.range.minDate},g.isLoadRange||n.get(null,function(e){g.range.fromDate=moment.max(moment(e.last_date).add(a.DEFAULT_RANGE_DATE_DAY.from,"d"),moment(e.first_date)).toDate(),g.range.toDate=moment.min(moment(g.range.toDate),moment(e.last_date)).toDate(),g.range.maxDate=moment(e.last_date).toDate(),g.range.minDate=moment(e.first_date).toDate(),g.isLoadRange=!0},function(e){console.log("Error api get Range"),u.handleErrorResponse(e)})}),u.$on("infoLocation",function(e,o){g.showInfoLoading=!0;var t=i.search();t.deviceId=o.id,t.direction=o.direction,i.search(t);var a=g.getRange(),n={period:a.isTime?"time-period":"day-period",id:o.id,direction:o.direction,dateFrom:a.fromDate.format("YYYY-MM-DD"),dateTo:a.toDate.format("YYYY-MM-DD"),timeFrom:a.isTime?a.fromTime.format("HH:mm"):null,timeTo:a.isTime?a.toTime.format("HH:mm"):null};r.get(n,function(e){u.selectDevice=e,g.renderGraph(),g.urlExportCsv=g.generateUrlExportCsv(n),g.showInfoLoading=!1},function(e){u.selectDevice=null,g.showInfoLoading=!1,console.log("Error api get Devices"),u.handleErrorResponse(e)})}),g.generateUrlExportCsv=function(e){var o="/devices/:id/:period/csv?".replace(":id",e.id).replace(":period",e.period);delete e.id,delete e.period;var t=jQuery.param(e);return a.API_URL+o+t},g.changeRange=function(){if(g.range.fromDate>=g.range.toDate||g.range.isTime&&g.range.fromTime>=g.range.toTime)u.selectDevice.traffics=[];else if(g.range.fromDate>=g.range.minDate&&g.range.toDate<=g.range.maxDate&&g.range.toDate>=g.range.minDate&&g.range.fromDate<=g.range.maxDate){var e=g.getRange(),o=i.search();o.fromDate=e.fromDate.format("YYYY-MM-DD"),o.toDate=e.toDate.format("YYYY-MM-DD"),o.fromTime=e.isTime?e.fromTime.format("HH:mm"):null,o.toTime=e.isTime?e.toTime.format("HH:mm"):null,o.isTime=e.isTime?null:0,i.search(o),u.selectDevice&&u.$emit("infoLocation",{id:u.selectDevice.id,direction:u.selectDevice.direction})}else u.selectDevice.traffics=[]},g.changeDirection=function(){u.$emit("infoLocation",{id:u.selectDevice.id,direction:u.selectDevice.direction})},g.getRange=function(){return{fromDate:moment(g.range.fromDate).isValid()?moment(g.range.fromDate):moment().add(a.DEFAULT_RANGE_DATE_DAY.from,"d"),toDate:moment(g.range.toDate).isValid()?moment(g.range.toDate):moment().add(a.DEFAULT_RANGE_DATE_DAY.to,"d"),fromTime:moment(g.range.fromTime).isValid()?moment(g.range.fromTime):moment({hour:a.DEFAULT_RANGE_TIME_HOUR.from}),toTime:moment(g.range.toTime).isValid()?moment(g.range.toTime):moment({hour:a.DEFAULT_RANGE_TIME_HOUR.to}),isTime:!!g.range.isTime}},g.renderGraph=function(){for(var e,o=["rgba(158, 158, 158, #alpha)","rgba(213, 0, 0, #alpha)","rgba(0, 123, 255, #alpha)","rgba(170, 0, 255, #alpha)","rgba(0, 200, 83, #alpha)","rgba(255, 214, 0, #alpha)","rgba(255, 109, 0, #alpha)","rgba(174, 234, 0, #alpha)","rgba(98, 0, 234, #alpha)","rgba(255, 171, 0, #alpha)","rgba(100, 221, 23, #alpha)","rgba(0, 184, 212, #alpha)"],t=jQuery.unique(u.selectDevice.traffics.map(function(e){return g.range.isTime?e.timeFrom:moment(e.date,"YYYY-MM-DD").format("D.M.YYYY")})),a=jQuery.unique(u.selectDevice.traffics.map(function(e){return e.typeVehicleId})),n=jQuery.grep(g.vehicles,function(e){return 0<=a.indexOf(e.id)}),i=[],r=[],l=0;e=n[l];l++){for(var c,s={label:e.name,backgroundColor:o[e.id].replace("#alpha","0.3"),borderColor:o[e.id].replace("#alpha","1"),borderWidth:2,data:[]},m={data:[],borderWidth:2,label:e.name,fill:!1,backgroundColor:o[e.id].replace("#alpha","0.3"),borderColor:o[e.id].replace("#alpha","1"),cubicInterpolationMode:"monotone",pointRadius:0},d=0,p=0;c=u.selectDevice.traffics[p];p++)(g.range.isTime&&t[d]!==c.timeFrom||!g.range.isTime&&t[d]!==moment(c.date,"YYYY-MM-DD").format("D.M.YYYY"))&&(d++,s.data.length<d&&(s.data.push(0),m.data.push(0))),c.typeVehicleId===e.id&&(s.data.push(g.range.isTime?c.numberVehicleAverage:c.numberVehicle),m.data.push(c.speedAverage<=0?0:c.speedAverage));i.push(s),r.push(m)}u.$emit("renderGraphNumberVehicles",{data:{labels:t,datasets:i}}),u.$emit("renderGraphAverageSpeed",{data:{labels:t,datasets:r}})},g.infoClose=function(){u.selectDevice=null;var e=i.search();e.deviceId=null,e.direction=null,i.search(e),u.$emit("setDefaultMap",null)}}]),angular.module("pvpk").controller("mainController",["$rootScope","$scope","$location","$window",function(n,i,r,e){this.$onInit=function(){i.showLoadingScreen=!0},e.onload=function(){var e=r.search();e.deviceId&&n.$emit("activeMarker",{id:e.deviceId}),i.$apply(function(){i.showLoadingScreen=!1})},n.$on("$locationChangeSuccess",function(e,o,t){var a=r.search();o!==t&&i.historyUrl?(i.historyUrl.q==i.historyUrl.q&&i.historyUrl.isDirection==a.isDirection||n.$emit("setSearchFromUrl",null),i.historyUrl.fromDate!==a.fromDate||i.historyUrl.toDate!==a.toDate||i.historyUrl.fromTime!==a.fromTime||i.historyUrl.toTime!==a.toTime?(n.$emit("setRangeFromUrl",null),a.deviceId&&n.$emit("infoLocation",{id:a.deviceId,direction:a.direction})):!a.deviceId||i.historyUrl.deviceId===a.deviceId&&i.historyUrl.direction===a.direction?!a.deviceId&&i.historyUrl.deviceId&&(n.selectDevice=null,n.$emit("setDefaultMap",null)):(n.$emit("infoLocation",{id:a.deviceId,direction:a.direction}),n.$emit("activeMarker",{id:a.deviceId}))):a.deviceId&&n.$emit("infoLocation",{id:a.deviceId,direction:a.direction}),i.historyUrl=r.search()}),n.handleErrorResponse=function(e){var o=jQuery("#modalError");switch(e.status){case 400:console.log("API ERROR 400"),i.modalError={title:"Neplatný požadavek",body:"Požadavek nemůže být vyřízen, poněvadž byl syntakticky nesprávně zapsán.",button:"OK"},o.modal("show");break;case 401:i.modalError={title:"Platnost webové aplikace vypršela",body:"Pro obnovení platnosti stačí stisknout tlačítko Obnovit.",button:"Obnovit",clickButton:i.reloadApp},o.modal({backdrop:"static",keyboard:!1});break;case 404:console.log("API ERROR 404"),i.modalError={title:"Nenalezen",body:"Záznam nebyl nalezen.",button:"OK"},o.modal("show");break;case 500:console.log("API ERROR 500"),i.modalError={title:"Chyba",body:"Chyba serveru. Zopakujte akci později.",button:"OK"},o.modal("show");break;case-1:console.log("API NOT CONNECTED"),i.modalError={title:"Připojení k internetu",body:"Nejste připojeni k internetu. Zkontrolujte připojení.",button:"OK"},o.modal("show");break;default:console.log("API UNKNOWN ERROR"),i.modalError={title:"Neočekávaná chyba",body:"Nastala neočekávaná chyba.",button:"OK"},o.modal("show")}},i.reloadApp=function(){e.location.reload()}}]),angular.module("pvpk").controller("mapController",["$rootScope","$scope","config","Device",function(t,n,a,e){this.$onInit=function(){n.markers=[],n.map=new google.maps.Map(document.getElementById("map"),{center:a.DEFAULT_POSITION,zoom:a.DEFAULT_ZOOM,minZoom:a.DEFAULT_ZOOM_MIN,zoomControl:!0,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,rotateControl:!1,fullscreenControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP}),e.query({showDirection:0},function(e){for(var o,t=0;o=e[t];t++)n.createMarker(o)},function(e){console.log("Error api all Devices"),t.handleErrorResponse(e)})},n.createMarker=function(e){if(e.lat&&e.lng){var o=new google.maps.Marker({map:n.map,position:{lat:e.lat,lng:e.lng},title:e.name,infoWindow:new google.maps.InfoWindow({content:'<h6 class="mb-1">'+e.name+"</h6><address>"+e.street+", "+e.town+"</address>"}),id:e.id});o.addListener("click",function(){n.closeInfoWindows(),o.infoWindow.open(n.map,o),t.$emit("infoLocation",{id:e.id})}),n.markers.push(o)}},t.$on("activeMarker",function(e,o){for(var t,a=0;t=n.markers[a];a++)t.id&&t.id===o.id&&t.infoWindow?(n.map.setCenter(t.getPosition()),n.map.setZoom(12),t.infoWindow.open(n.map,t)):t.infoWindow.close()}),t.$on("setDefaultMap",function(e,o){n.map.setCenter(a.DEFAULT_POSITION),n.map.setZoom(a.DEFAULT_ZOOM),n.closeInfoWindows()}),n.closeInfoWindows=function(){for(var e,o=0;e=n.markers[o];o++)e.infoWindow.close()}}]),angular.module("pvpk").controller("searchController",["$rootScope","$scope","$location","config","Device",function(t,a,n,e,o){this.$onInit=function(){a.config=e,a.locations=[],a.showSearchLoading=!1,t.$emit("setSearchFromUrl",null)},a.searchLocations=function(){var e=n.search();e.q=a.search.q,e.isDirection=a.search.isDirection?1:null,n.search(e),!a.search.q||a.search.q.length<=1?a.locations=[]:(a.showSearchLoading=!0,o.query({address:a.search.q,showDirection:a.search.isDirection?1:0},function(e){a.locations=e,a.showSearchLoading=!1},function(e){a.showSearchLoading=!1,console.log("Error api all Devices"),t.handleErrorResponse(e)}))},t.$on("setSearchFromUrl",function(e,o){var t=n.search();a.search={q:t.q,isDirection:!!t.isDirection&&!!+t.isDirection},a.searchLocations()}),a.selectDevice=function(e,o){t.$emit("activeMarker",{id:e}),t.$emit("infoLocation",{id:e,direction:o})}}]),angular.module("pvpk").component("graphAverageSpeed",{template:'<div><canvas id="graphAverageSpeed" class="graph-size mb-5"></canvas></div>',controller:["$rootScope","$scope",function(e,a){e.$on("renderGraphAverageSpeed",function(e,o){var t=document.getElementById("graphAverageSpeed").getContext("2d");a.graphLine&&a.graphLine.destroy(),a.graphLine=new Chart(t,{type:"line",data:o.data,options:{responsive:!0,pointDot:!1,legend:{position:"bottom"},scales:{xAxes:[{ticks:{autoSkip:!0,maxTicksLimit:15}}],yAxes:[{scaleLabel:{display:!0,labelString:"km/h"},ticks:{beginAtZero:!0,suggestedMax:70}}]},tooltips:{mode:"index",intersect:!1,callbacks:{label:function(e){return e.yLabel+" km/h"}}}}})})}]}),angular.module("pvpk").component("graphNumberVehicles",{template:'<div><canvas id="graphNumberVehicles" class="graph-size mb-5"></canvas></div>',controller:["$rootScope","$scope",function(e,a){e.$on("renderGraphNumberVehicles",function(e,o){var t=document.getElementById("graphNumberVehicles").getContext("2d");a.graphNumberVehicles&&a.graphNumberVehicles.destroy(),a.graphNumberVehicles=new Chart(t,{type:"bar",data:o.data,options:{responsive:!0,onResize:function(e,o){e.options.legend.display=240<o.height,e.update()},legend:{position:"bottom"},scales:{xAxes:[{stacked:!0,ticks:{autoSkip:!0,maxTicksLimit:15}}],yAxes:[{scaleLabel:{display:!0,labelString:"počet vozidel"},stacked:!0}]},tooltips:{mode:"index",intersect:!1}}})})}]});
//# sourceMappingURL=app.min.js.map
